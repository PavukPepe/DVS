{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Главная</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
            crossorigin="anonymous"
    />
    <link
            href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100..900;1,100..900&family=Rubik:wght@300..900&display=swap"
            rel="stylesheet"
    />
    <link rel="stylesheet" href="{% static 'engines/css/drop_style.css' %}">
    <link rel="stylesheet" href="{% static 'engines/css/header.css' %}">
    <link rel="stylesheet" href="{% static 'engines/css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'engines/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'engines/css/toggle.css' %}">
    <style>
        .suggestions-list {
            position: absolute;
            z-index: 999;
            background-color: white;
            width: 30%;
            max-height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 0;
            margin-top: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none; /* Скрываем по умолчанию */
        }

        .suggestions-list li {
            padding: 8px 16px;
            cursor: pointer;
        }

        .suggestions-list li:hover {
            background-color: #f2f2f2;
        }
    </style>
    <!-- Links -->
</head>

<body>
{% include 'header.html' %}

<div class="background"></div>
<main>
    <aside>
        <div class="button-area">
            <button>По автомобилю</button>
            <button>По VIN авто</button>
        </div>
        <div class="filter">
            <div class="blur">
                <div class="form-area">
                    <form method="GET" id="search-form">
                        <select name="brand" onchange="this.form.submit()">
                            <option value="">Все марки</option>
                            {% for brand in brands %}
                                <option value="{{ brand.id }}"
                                        {% if brand.id|stringformat:"s" == selected_brand_id %}selected{% endif %}>{{ brand.name }}</option>
                            {% endfor %}
                        </select>

                        <select name="model" onchange="this.form.submit()">
                            <option value="">Все модели</option>
                            {% for model in models %}
                                <option value="{{ model.id }}"
                                        {% if model.id|stringformat:"s" == selected_model_id %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>

                        <select name="generation" onchange="this.form.submit()">
                            <option value="">Все поколения</option>
                            {% for generation in generations %}
                                <option value="{{ generation.id }}"
                                        {% if generation.id|stringformat:"s" == selected_generation_id %}selected{% endif %}>{{ generation }}</option>
                            {% endfor %}
                        </select>

                        <label class="toggle">
                            <input class="toggle-checkbox" type="checkbox" name="condition" value="Новый"
                                   id="id_condition_0" {% if 'Новый' in selected_conditions %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <div class="toggle-switch"></div>
                            <span class="toggle-label">Новые</span>
                        </label>

                        <label class="toggle">
                            <input class="toggle-checkbox" type="checkbox" name="condition" value="Б/у"
                                   id="id_condition_1" {% if 'Б/у' in selected_conditions %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <div class="toggle-switch"></div>
                            <span class="toggle-label">Б/У</span>
                        </label>
                        <button type="button" class="drop" onclick="resetFilters()">Сбросить</button>
                    </form>
                </div>
            </div> <!-- Closing the div.blur -->
        </div>
    </aside>

    <div class="wrap">
        <div class="card-area">
            {#            <div class="searcher">#}
            {#                <input type="text" placeholder="Поиск"/>#}
            {#            </div>#}
            <form method="GET" class="searcher">
                <input type="text" name="name" placeholder="Поиск">
            </form>
            <div class="shop-part">
                {% for item in engines %}
                    <div class="card">
                        <img src="media/{{ item.photo }}" width="100%" alt="#">
                        <h2 class="good-name">{{ item.name }}</h2>
                        <table>
                            <tbody>
                            <tr>
                                <th>Тип топлива</th>
                                <td>{{ item.fuel_type }}</td>
                            </tr>
                            <tr>
                                <th>Объем</th>
                                <td>{{ item.volume }}</td>
                            </tr>
                            <tr>
                                <th>Страна производитель</th>
                                <td>{{ item.state_of_origin }}</td>
                            </tr>
                            <tr>
                                <th>Состояние</th>
                                <td>{{ item.condition }}</td>
                            </tr>
                            </tbody>
                        </table>
                        <div class="prices">
                            <div class="price-enable">
                                <p>В наличии:</p>
                                <p class="price">{{ item.price }}</p>
                                <p>RUB</p>
                            </div>
                            <div class="price-disable">
                                <p>На заказ:</p>
                                <p class="price">{{ item.price_order }}</p>
                                <p>RUB</p>
                            </div>
                        </div>
                        <button class="Order">Оставить заявку</button>
                    </div>
                {% empty %}
                    <li>Ничего не найдено.</li>
                {% endfor %}
            </div>
        </div>
    </div>
</main>

<!-- Modal -->
{% include 'popapp.html' %}
{% include 'footer.html' %}

<script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"
></script>

<script>
    const orderButtons = document.querySelectorAll(".Order");

    const telfield = document.querySelector("#phone");

    telfield.addEventListener("input", function () {
        // Убираем все недопустимые символы
        this.value = this.value.replace(/[^0-9+]/g, "");

        // Проверяем, чтобы '+' был в начале
        if (!this.value.startsWith("+")) {
            this.value = this.value.replace(/^\+/, ""); // Убираем '+' если он не в начале
        }

        // Ограничиваем ввод до 10 цифр после '+7'
        const prefix = "+7 ";
        const numbers = this.value.replace(/^\+7/, "").trim();
        const maxDigits = 10;

        if (numbers.length > maxDigits) {
            this.value = prefix + numbers.slice(0, maxDigits); // Ограничиваем до 10 цифр
        } else {
            this.value = prefix + numbers;
        }

        // Форматируем ввод по требуемому шаблону
        const formatted = this.value
            .replace(/(\+7\s)(\d{3})(\d{3})(\d{2})(\d{2})/, "$1$2 $3 $4 $5")
            .trim();

        this.value = formatted;
    });

    telfield.addEventListener("focus", function () {
        if (this.value === "") {
            this.value = "+7 ";
        }
    });

    orderButtons.forEach((button) => {
        button.addEventListener("click", function () {
            // Получаем родительский элемент карточки
            const card = this.closest(".card");
            const price = card.querySelector(".good-name").textContent;

            // Устанавливаем значение цены в модальное окно
            document.getElementById("good-name").value = price;

            // Показываем модальное окно
            const modal = new bootstrap.Modal(
                document.getElementById("orderModal")
            );
            modal.show();
        });
    });

    document.getElementById("confirmOrder").addEventListener("click", () => {
        const form = document.getElementById("orderForm");
        if (form.checkValidity()) {
            // Обработка заказа
            alert("Заказ подтвержден!");
            document.getElementById('orderForm').submit();
            const modal = bootstrap.Modal.getInstance(
                document.getElementById("orderModal")
            );
            modal.hide();
        } else {
            form.reportValidity();
        }
    });

    function resetFilters() {
        // Сброс значений полей формы
        const form = document.getElementById('search-form');
        form.reset();

        // Необходимая логика для обновления URL или выполнения другого действия
        // Например, можно перенаправить на страницу без параметров
        window.location.href = window.location.pathname;
    }

</script>
</body>
</html>
